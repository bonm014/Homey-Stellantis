<!DOCTYPE html>
<html>
  <head>
    <!-- The '/homey.js' script must be included in your settings view to work -->
    <script
      type="text/javascript"
      src="/homey.js"
      data-origin="settings"
    ></script>

    <link rel="stylesheet" href="settings-style.css" />
</head>
<body>
    <h2>Stellantis Account Configuration</h2>
    
    <!-- Step 1: Brand & Country Selection -->
    <div class="step active" id="step1">
        <h3>
            <span class="step-number">1</span>
            Select Brand & Country
        </h3>
        
        <label for="brand">Vehicle Brand:</label>
        <select id="brand">
            <option value="MyPeugeot">Peugeot</option>
            <option value="MyCitroen">Citro√´n</option>
            <option value="MyDS">DS</option>
            <option value="MyOpel">Opel</option>
            <option value="MyVauxhall">Vauxhall</option>
        </select>
        
        <label for="country">Country:</label>
        <select id="country"></select>
        
        <button onclick="generateAuthUrl()">Continue to Login</button>
    </div>
    
    <!-- Step 2: Login & Get Authorization Code -->
    <div class="step hidden" id="step2">
        <h3>
            <span class="step-number">2</span>
            Login with Stellantis Account
        </h3>
        
        <div class="instructions">
            <strong>Follow these steps:</strong>
            <ol>
                <li>Copy the link below</li>
                <li>Open a new window and navigate to the link</li>
                <li>Login with your Stellantis account credentials</li>
                <li>The browser will show an error page (this is normal!)</li>
                <li>Open Developer Tools, and open the Network tab</li>
                <li>Copy the <strong>complete URL</strong> from the network trace (mymap://oauth2redirect/nl?code=...&state=...)</li>
                <li>Paste it in the field below</li>
            </ol>
        </div>
        
        <label for="authUrlDisplay">Stellantis login:</label>
        <textarea id="authUrlDisplay" placeholder="" readonly></textarea>

        <label for="redirectUrl">Paste the redirect URL here:</label>
        <textarea id="redirectUrl" placeholder="mymap://oauth2redirect/nl?code=...&state=..."></textarea>
        
        <button onclick="extractAndSaveCode()">Continue</button>
        <button class="secondary" onclick="goToStep(1)">Back</button>
    </div>
    
    <!-- Step 3: Code Saved, Getting Token -->
    <div class="step hidden" id="step3">
        <h3>
            <span class="step-number">3</span>
            Getting Access Token
        </h3>
        
        <div id="tokenStatus" class="message info">
            ‚è≥ Requesting access token from Stellantis...
        </div>
        
        <div id="otpSection" class="hidden">
            <div class="message info">
                üì± SMS Verification Required<br>
                Please check your phone for a 6-digit verification code.
            </div>
            
            <label for="otpCode">Enter 6-digit OTP code:</label>
            <input type="text" id="otpCode" maxlength="6" placeholder="123456" pattern="[0-9]{6}">
            
            <button onclick="submitOTP()">Verify OTP</button>
        </div>
        
        <button class="secondary" onclick="location.reload()">Start Over</button>
    </div>
    
    <!-- Step 4: Success -->
    <div class="step hidden" id="step4">
        <h3>
            <span class="step-number">4</span>
            Configuration Complete
        </h3>
        
        <div class="message success">
            ‚úÖ Your Stellantis account has been successfully connected!
        </div>
        
        <div id="accountInfo"></div>
        
        <button onclick="location.reload()">Configure Another Account</button>
    </div>

    <script>
        // Brand configuration
        const CONFIG = {
            MyPeugeot: {
                oauth_url: 'https://idpcvs.peugeot.com',
                realm: 'clientsB2CPeugeot',
                scheme: 'mymap',
                configs: {
                    NL: { locale: 'nl-NL', client_id: '1eebc2d5-5df3-459b-a624-20abfcf82530', client_secret: 'T5tP7iS0cO8sC0lA2iE2aR7gK6uE5rF3lJ8pC3nO1pR7tL8vU1' },
                    DE: { locale: 'de-DE', client_id: '1eebc2d5-5df3-459b-a624-20abfcf82530', client_secret: 'T5tP7iS0cO8sC0lA2iE2aR7gK6uE5rF3lJ8pC3nO1pR7tL8vU1' },
                    FR: { locale: 'fr-FR', client_id: '1eebc2d5-5df3-459b-a624-20abfcf82530', client_secret: 'T5tP7iS0cO8sC0lA2iE2aR7gK6uE5rF3lJ8pC3nO1pR7tL8vU1' },
                    GB: { locale: 'en-GB', client_id: '1eebc2d5-5df3-459b-a624-20abfcf82530', client_secret: 'T5tP7iS0cO8sC0lA2iE2aR7gK6uE5rF3lJ8pC3nO1pR7tL8vU1' },
                    BE: { locale: 'fr-BE', client_id: '1eebc2d5-5df3-459b-a624-20abfcf82530', client_secret: 'T5tP7iS0cO8sC0lA2iE2aR7gK6uE5rF3lJ8pC3nO1pR7tL8vU1' }
                }
            },
            MyCitroen: {
                oauth_url: 'https://idpcvs.citroen.com',
                realm: 'clientsB2CCitroen',
                scheme: 'mymacsdk',
                configs: {
                    NL: { locale: 'nl-NL', client_id: '49799a4b-f335-4de2-bafb-e198a3f54ef9', client_secret: 'bQ8lW3eC8eG7wG0lN7uR6dE2cY4kW1yD8jJ4tT6aA3qJ5cM3dE' },
                    DE: { locale: 'de-DE', client_id: '5364defc-80e6-447b-bec6-4af8d1542cae', client_secret: 'iE0cD8bB0yJ0dS6rO3nN1hI2wU7uA5xR4gP7lD6vM0oH0nS8dN' },
                    FR: { locale: 'fr-FR', client_id: '5364defc-80e6-447b-bec6-4af8d1542cae', client_secret: 'iE0cD8bB0yJ0dS6rO3nN1hI2wU7uA5xR4gP7lD6vM0oH0nS8dN' },
                    GB: { locale: 'en-GB', client_id: '5364defc-80e6-447b-bec6-4af8d1542cae', client_secret: 'iE0cD8bB0yJ0dS6rO3nN1hI2wU7uA5xR4gP7lD6vM0oH0nS8dN' },
                    BE: { locale: 'fr-BE', client_id: '5364defc-80e6-447b-bec6-4af8d1542cae', client_secret: 'iE0cD8bB0yJ0dS6rO3nN1hI2wU7uA5xR4gP7lD6vM0oH0nS8dN' }
                }
            },
            MyDS: {
                oauth_url: 'https://idpcvs.driveds.com',
                realm: 'clientsB2CDS',
                scheme: 'mymdssdk',
                configs: {
                    NL: { locale: 'nl-NL', client_id: 'cbf74ee7-a303-4c3d-aba3-29f5994e2dfa', client_secret: 'X6bE6yQ3tH1cG5oA6aW4fS6hK0cR0aK5yN2wE4hP8vL8oW5gU3' },
                    DE: { locale: 'de-DE', client_id: 'cbf74ee7-a303-4c3d-aba3-29f5994e2dfa', client_secret: 'X6bE6yQ3tH1cG5oA6aW4fS6hK0cR0aK5yN2wE4hP8vL8oW5gU3' },
                    FR: { locale: 'fr-FR', client_id: 'cbf74ee7-a303-4c3d-aba3-29f5994e2dfa', client_secret: 'X6bE6yQ3tH1cG5oA6aW4fS6hK0cR0aK5yN2wE4hP8vL8oW5gU3' },
                    GB: { locale: 'en-GB', client_id: 'cbf74ee7-a303-4c3d-aba3-29f5994e2dfa', client_secret: 'X6bE6yQ3tH1cG5oA6aW4fS6hK0cR0aK5yN2wE4hP8vL8oW5gU3' },
                    BE: { locale: 'fr-BE', client_id: 'cbf74ee7-a303-4c3d-aba3-29f5994e2dfa', client_secret: 'X6bE6yQ3tH1cG5oA6aW4fS6hK0cR0aK5yN2wE4hP8vL8oW5gU3' }
                }
            },
            MyOpel: {
                oauth_url: 'https://idpcvs.opel.com',
                realm: 'clientsB2COpel',
                scheme: 'mymopsdk',
                configs: {
                    NL: { locale: 'nl-NL', client_id: '07364655-93cb-4194-8158-6b035ac2c24c', client_secret: 'F2kK7lC5kF5qN7tM0wT8kE3cW1dP0wC5pI6vC0sQ5iP5cN8cJ8' },
                    DE: { locale: 'de-DE', client_id: '07364655-93cb-4194-8158-6b035ac2c24c', client_secret: 'F2kK7lC5kF5qN7tM0wT8kE3cW1dP0wC5pI6vC0sQ5iP5cN8cJ8' },
                    FR: { locale: 'fr-FR', client_id: '07364655-93cb-4194-8158-6b035ac2c24c', client_secret: 'F2kK7lC5kF5qN7tM0wT8kE3cW1dP0wC5pI6vC0sQ5iP5cN8cJ8' },
                    BE: { locale: 'fr-BE', client_id: '07364655-93cb-4194-8158-6b035ac2c24c', client_secret: 'F2kK7lC5kF5qN7tM0wT8kE3cW1dP0wC5pI6vC0sQ5iP5cN8cJ8' }
                }
            },
            MyVauxhall: {
                oauth_url: 'https://idpcvs.vauxhall.co.uk',
                realm: 'clientsB2CVauxhall',
                scheme: 'mymvxsdk',
                configs: {
                    GB: { locale: 'en-GB', client_id: '122f3511-4f74-4a0c-bcda-af2f3b2e3a65', client_secret: 'N1iY3jO4jI1sF2yS6yJ3rG7xQ4kL4kK1dO3xT5uX6dF3kW8gI6' }
                }
            }
        };

        let state, authUrl, authCode;
        let selectedBrand, selectedCountry, brandData, countryData;

        // Initialize
        updateCountries();
        document.getElementById('brand').addEventListener('change', updateCountries);

        function updateCountries() {
            const brand = document.getElementById('brand').value;
            const select = document.getElementById('country');
            select.innerHTML = '';
            
            Object.keys(CONFIG[brand].configs).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = `${c} (${CONFIG[brand].configs[c].locale})`;
                select.add(opt);
            });
        }

        function generateAuthUrl() {
            selectedBrand = document.getElementById('brand').value;
            selectedCountry = document.getElementById('country').value;
            
            brandData = CONFIG[selectedBrand];
            countryData = brandData.configs[selectedCountry];
            
            // Generate state
            state = 'xxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
            
            const redirectUri = `${brandData.scheme}://oauth2redirect/${selectedCountry.toLowerCase()}`;
            
            const params = new URLSearchParams({
                client_id: countryData.client_id,
                response_type: 'code',
                scope: 'openid profile email',
                redirect_uri: redirectUri,
                state: state
            });
            
            authUrl = `${brandData.oauth_url}/am/oauth2/authorize?${params}`;

            console.log(authUrl);
            
            document.getElementById('authUrlDisplay').textContent = authUrl;
            goToStep(2);
        }

        function openAuthUrl() {
            window.open(authUrl, '_blank');
        }

        function extractAndSaveCode() {
            const redirectUrl = document.getElementById('redirectUrl').value.trim();
            
            if (!redirectUrl.includes('oauth2redirect')) {
                showMessage('tokenStatus', 'Invalid URL. Must contain oauth2redirect', 'error');
                return;
            }
            
            try {
                const url = new URL(redirectUrl);
                authCode = url.searchParams.get('code');
                const urlState = url.searchParams.get('state');

                console.log(authCode);
                console.log(urlState);
                
                if (!authCode) {
                    showMessage('tokenStatus', 'No authorization code found in URL', 'error');
                    return;
                }
                
                if (urlState !== state) {
                    showMessage('tokenStatus', 'State mismatch - security error. Please start over.', 'error');
                    return;
                }
                
                // Save code to Homey store
                saveCodeToStore();
                
            } catch (e) {
                showMessage('tokenStatus', 'Error parsing URL: ' + e.message, 'error');
            }
        }

        function saveCodeToStore() {
            // Save to Homey settings store
            const authData = {
                brand: selectedBrand,
                country: selectedCountry,
                authCode: authCode,
                client_id: countryData.client_id,
                client_secret: countryData.client_secret,
                oauth_url: brandData.oauth_url,
                redirect_uri: `${brandData.scheme}://oauth2redirect/${selectedCountry.toLowerCase()}`,
                state: state,
                timestamp: Date.now()
            };
            
            Homey.set('auth_data', authData, function(err) {
                if (err) {
                    showMessage('tokenStatus', 'Error saving: ' + err, 'error');
                    return;
                }
                
                console.log('Authorization code saved to store');
                
                // Go to step 3 and request token from backend
                goToStep(3);
                requestTokenFromBackend();
            });
        }

        function requestTokenFromBackend() {
            showMessage('tokenStatus', '‚è≥ Requesting access token from Stellantis...', 'info');
            
            // Call backend to exchange code for token
            // In SDK 3, API methods are called via the api object name from app.json
            Homey.api('POST', '/exchangeToken', null, function(err, result) {
                if (err) {
                    showMessage('tokenStatus', 'Error: ' + err.message, 'error');
                    return;
                }

                if (result.success) {
                    // Success!
                    onTokenReceived(result);
                } else {
                    showMessage('tokenStatus', 'Error: ' + (result.error || 'Unknown error'), 'error');
                }
            });
        }

        function submitOTP() {
            const otp = document.getElementById('otpCode').value.trim();
            
            if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
                showMessage('tokenStatus', 'OTP must be 6 digits', 'error');
                return;
            }
            
            showMessage('tokenStatus', '‚è≥ Verifying OTP...', 'info');
            document.getElementById('otpSection').classList.add('hidden');
            
            // Call backend with OTP
            Homey.api('POST', '/exchangeTokenOTP', { otp: otp }, function(err, result) {
                if (err) {
                    showMessage('tokenStatus', 'Error: ' + err.message, 'error');
                    document.getElementById('otpSection').classList.remove('hidden');
                    return;
                }
                
                if (result.success) {
                    onTokenReceived(result);
                } else {
                    showMessage('tokenStatus', 'OTP verification failed: ' + (result.error || 'Invalid code'), 'error');
                    document.getElementById('otpSection').classList.remove('hidden');
                }
            });
        }

        function onTokenReceived(result) {
            showMessage('tokenStatus', '‚úÖ Access token received and saved!', 'success');
            
            // Show account info
            const info = `
                <p><strong>Brand:</strong> ${selectedBrand}</p>
                <p><strong>Country:</strong> ${selectedCountry}</p>
                <p><strong>Token expires:</strong> ${new Date(result.expiresAt).toLocaleString()}</p>
            `;
            document.getElementById('accountInfo').innerHTML = info;
            
            setTimeout(() => {
                goToStep(4);
            }, 1000);
        }

        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = 'message ' + type;
        }

        function goToStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(s => {
                s.classList.add('hidden');
                s.classList.remove('active');
            });
            
            // Show target step
            const targetStep = document.getElementById('step' + stepNumber);
            targetStep.classList.remove('hidden');
            targetStep.classList.add('active');
            
            // Mark previous steps as completed
            for (let i = 1; i < stepNumber; i++) {
                document.getElementById('step' + i).classList.add('completed');
            }
        }

        // Ready callback for Homey
        function onHomeyReady(homeyReady) {
            Homey = homeyReady;
            Homey.ready();
        }
    </script>
</body>
</html>